# Chronic Fatigue Model Implementation - Task Breakdown

## Summary
Implementing the Revised Chronic Fatigue Model as specified in [REVISED_CHRONIC_FATIGUE_MODEL.md](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/REVISED_CHRONIC_FATIGUE_MODEL.md). This replaces the current EWMA-based ATL/CTL/TSB system with a dual-compartment fatigue model featuring auto-estimated Critical Power (eCP), physiological cost calculation from second-by-second data, and revised questionnaire integration.

---

## Phase 1: Foundation - Type System & Data Model
> New types, interfaces, and data storage structures

- [ ] **1.1** Define new types in [types.ts](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/types.ts):
  - `CriticalPowerEstimate` (CP, W', confidence, timestamp, method)
  - `PhysiologicalCostData` (daily load, acute deficit history)
  - `ChronicFatigueState` (S_meta, S_struct, Cap_meta, Cap_struct)
  - `RecoveryEfficiency` (φ_recovery value and sources)
  - `MMPRecord` (duration, power, date, RPE, isMaxEffort)
- [ ] **1.2** Extend [Session](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/types.ts#58-79) interface:
  - Add optional `secondBySecondPower?: number[]` for granular power data
  - Add optional `mmsBestEfforts?: MMPRecord[]` for extracted MMP data
- [ ] **1.3** Extend [ProgramRecord](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/types.ts#80-95) interface:
  - Add `criticalPowerEstimate?: CriticalPowerEstimate`
  - Add `chronicFatigueState?: ChronicFatigueState`
- [ ] **1.4** Update [QuestionnaireResponse](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/types.ts#240-245) or add new integration types:
  - Map to `RecoveryInputs` (sleep, nutrition) vs `StateInputs` (soreness, energy)
- [ ] **1.5** Update storage keys in [useAppState.ts](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/hooks/useAppState.ts):
  - Add persistence for CP estimates and chronic state

---

## Phase 2: eCP Estimation Engine
> Auto-estimation of Critical Power from training history

- [ ] **2.1** Create `utils/criticalPowerEngine.ts`:
  - `extractMMPBests()` - Extract best efforts for T ∈ [3m, 5m, 12m, 20m, 40m]
  - `fitCPModel()` - Weighted least-squares regression on P vs 1/t
  - `calculateECP()` - Main engine combining MMP extraction and regression
- [ ] **2.2** Implement RPE cross-checks:
  - Submaximal anchor: If RPE ≤ 5 for >20 min, enforce CP ≥ P_sub
  - Supra-maximal flag: RPE=10 with failure reinforces W' cap
  - Only use efforts with RPE ≥ 9 for "Upper Bound" fit
- [ ] **2.3** Implement CP decay:
  - If no max efforts (>90% CP) for 28 days, apply -0.5%/week decay
- [ ] **2.4** Add backfill logic:
  - Run eCP algorithm on last 60 days of session data
- [ ] **2.5** Write comprehensive unit tests in `criticalPowerEngine.test.ts`

---

## Phase 3: Physiological Cost Calculation
> High-resolution load calculation from second-by-second power data

- [ ] **3.1** Create `utils/physiologicalCostEngine.ts`:
  - `trackAcuteDeficit()` - W'bal-style acute deficit tracking
  - `calculateInstantaneousCost()` - Cost(t) = P(t) × (1 + K_fatigue × D_acute/W')
  - `integrateDailyCost()` - ∫ Cost(t) dt for daily load
- [ ] **3.2** Define constants:
  - K_fatigue ≈ 1.5 (stress multiplier)
  - ReferenceScale for normalizing daily load
- [ ] **3.3** Handle fallback for sessions without second-by-second data:
  - Use existing average power with estimated variability factor
- [ ] **3.4** Extract second-by-second data from guided sessions:
  - Modify [useSessionTimer.ts](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/hooks/useSessionTimer.ts) to capture more granular power history
  - Update `powerHistory` format in [SessionResult](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/types.ts#198-232)
- [ ] **3.5** Write comprehensive unit tests in `physiologicalCostEngine.test.ts`

---

## Phase 4: Dual-Compartment Chronic State
> Metabolic Freshness (S_meta) and Structural Health (S_struct)

- [ ] **4.1** Create `utils/chronicFatigueModel.ts`:
  - `updateMetabolicFreshness()` - S_meta dynamics with τ_meta ≈ 2 days
  - `updateStructuralHealth()` - S_struct dynamics with τ_struct ≈ 15 days
  - [calculateReadinessScore()](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/utils/simulationEngine.ts#84-92) - Composite score from both compartments
- [ ] **4.2** Define constants:
  - τ_meta = 2 days, τ_struct = 15 days
  - w_1 = 0.6, w_2 = 0.4 (compartment weights)
  - Cap_meta, Cap_struct (capacity values)
  - σ_impact = 1.0 (impact multiplier, configurable)
- [ ] **4.3** Implement state initialization:
  - Backfill from t_-60 to t_now to seed initial states
- [ ] **4.4** Implement interpretive logic:
  - High readiness (>80): green light for intensity
  - Metabolic fatigue pattern: suggest Zone 2/Endurance
  - Structural fatigue pattern: suggest Active Recovery
- [ ] **4.5** Write comprehensive unit tests in `chronicFatigueModel.test.ts`

---

## Phase 5: Questionnaire Integration Revision
> Recovery efficiency modulation and Bayesian state corrections

- [ ] **5.1** Modify [utils/questionnaireConfig.ts](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/utils/questionnaireConfig.ts):
  - Calculate φ_recovery ∈ [0.5, 1.5] from sleep, nutrition, stress inputs
  - Map synergy effects to φ_recovery penalties
  - Map trends to CP estimate adjustments
- [ ] **5.2** Implement Recovery Efficiency Modulation:
  - Apply φ_recovery to τ_meta in S_meta decay equation
  - Perfect sleep/nutrition → φ = 1.25 (faster recovery)
  - Terrible sleep/stress → φ = 0.6 (slower recovery)
- [ ] **5.3** Implement Bayesian State Corrections:
  - Structural Correction (Soreness): Force-inject S_struct if model mismatch
  - Metabolic Correction (Energy): Apply fatigue penalty if hidden fatigue detected
- [ ] **5.4** Restructure question categories:
  - "Recovery Inputs": sleep, nutrition, stress → φ_recovery
  - "State Inputs": soreness, energy → state corrections
- [ ] **5.5** Update tests in [questionnaireAlgorithm.test.ts](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/utils/questionnaireAlgorithm.test.ts)

---

## Phase 6: RPE Correction Loop
> Model self-correction based on session perceived difficulty

- [ ] **6.1** Create `utils/rpeCorrectionLoop.ts`:
  - Calculate predicted difficulty from CP and chronic state
  - Compare to actual session RPE
  - Track mismatch history
- [ ] **6.2** Implement penalty load system:
  - If RPE >> predicted → apply penalty load to S_meta for 24 hours
- [ ] **6.3** Implement CP downgrade trigger:
  - If mismatch persists for >3 sessions → trigger CP ↓2%
- [ ] **6.4** Integrate with session completion flow in [hooks/useSessionTimer.ts](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/hooks/useSessionTimer.ts)
- [ ] **6.5** Write unit tests in `rpeCorrectionLoop.test.ts`

---

## Phase 7: Update useMetrics Hook
> Central hook modification to use new model

- [ ] **7.1** Refactor [hooks/useMetrics.ts](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/hooks/useMetrics.ts):
  - Replace ATL/CTL/TSB calculations with new chronic model
  - Integrate eCP for power calculations
  - Use physiological cost for daily load
  - Apply questionnaire integration via new system
- [ ] **7.2** Update [MetricsResult](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/hooks/useMetrics.ts#22-40) interface:
  - Add `sMetabolic`, `sStructural`, `eCP`, `wPrime`
  - Keep legacy fields for backward compatibility during transition
  - Add `readinessInterpretation` for UI guidance
- [ ] **7.3** Implement migration path:
  - Add feature flag for gradual rollout
  - Keep legacy calculations available for comparison
- [ ] **7.4** Update tests in `hooks` and related utils

---

## Phase 8: Update Chart Analytics
> Chart.tsx and related visualization updates

- [ ] **8.1** Update [components/Chart.tsx](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/components/Chart.tsx):
  - Replace ATL/CTL lines with S_meta/S_struct visualizations
  - Add eCP trend line
  - Update tooltip content for new metrics
- [ ] **8.2** Update [generateMetrics()](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/components/Chart.tsx#213-289) function:
  - Use new chronic fatigue model for historical charting
- [ ] **8.3** Update color schemes:
  - Distinguish Metabolic vs Structural fatigue visually
- [ ] **8.4** Add new chart options:
  - Toggle between compartments view
  - Show CP estimation confidence band

---

## Phase 9: Update Dashboard & Insights
> User-facing metric displays

- [ ] **9.1** Update [components/DashboardTab.tsx](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/components/DashboardTab.tsx):
  - Display new readiness score with interpretation
  - Show fatigue breakdown (metabolic vs structural)
  - Display eCP value with confidence indicator
- [ ] **9.2** Update [components/InsightsTab.tsx](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/components/InsightsTab.tsx):
  - Add CP history tracking
  - Add chronic state trend analysis
  - Update recommendations based on new interpretive logic
- [ ] **9.3** Update [utils/insightsUtils.ts](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/utils/insightsUtils.ts):
  - Add new insight generators for dual-compartment model
  - Add CP progression insights

---

## Phase 10: Update Auto-Adaptive System
> Monte Carlo simulation and adjustments

- [ ] **10.1** Update [utils/simulationEngine.ts](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/utils/simulationEngine.ts):
  - Use new chronic fatigue model in simulations
  - Output S_meta and S_struct percentiles
- [ ] **10.2** Update [utils/autoAdaptiveModifiers.ts](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/utils/autoAdaptiveModifiers.ts):
  - Base adjustments on dual-compartment state
  - Different adjustments for metabolic vs structural issues
- [ ] **10.3** Update [utils/autoAdaptiveTypes.ts](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/utils/autoAdaptiveTypes.ts):
  - Update [WeekPercentiles](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/utils/autoAdaptiveTypes.ts#24-40) for new model metrics
- [ ] **10.4** Regenerate simulation caches for templates

---

## Phase 11: Update Session Logging & Completion
> Session data capture and processing

- [ ] **11.1** Update [hooks/useSessionTimer.ts](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/hooks/useSessionTimer.ts):
  - Capture finer-grained power history (1-second resolution if possible)
  - Extract MMP bests at session end
- [ ] **11.2** Update [components/SessionLog.tsx](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/components/SessionLog.tsx):
  - Process power data for physiological cost calculation
  - Trigger eCP update if session contains max-effort data
- [ ] **11.3** Update session completion flow:
  - Apply RPE correction loop checks
  - Update chronic state immediately after session

---

## Phase 12: Documentation & Architecture Updates
> Technical documentation and guides

- [ ] **12.1** Update [ARCHITECTURE.md](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/ARCHITECTURE.md):
  - Document new metrics engine architecture
  - Add data flow diagrams for chronic fatigue model
  - Document CP estimation process
- [ ] **12.2** Create [CHRONIC_FATIGUE_MODEL.md](file:///c:/Users/marce/Downloads/cardiokinetic%281%29/REVISED_CHRONIC_FATIGUE_MODEL.md):
  - In-app developer documentation
  - Mathematical formulas reference
  - Calibration guidance
- [ ] **12.3** Update code comments throughout affected files

---

## Phase 13: Testing & Validation
> Comprehensive testing suite

- [ ] **13.1** Unit tests for all new utility modules
- [ ] **13.2** Integration tests for full calculation chain
- [ ] **13.3** Regression tests to compare with legacy model
- [ ] **13.4** Edge case tests:
  - New users (no history)
  - Sparse data (gaps in training)
  - Very high/low training loads
- [ ] **13.5** Manual testing scenarios

---

## Phase 14: Migration & Rollout
> Data migration and feature rollout

- [ ] **14.1** Create migration utility:
  - Calculate initial chronic state from existing session history
  - Estimate initial CP from existing data
- [ ] **14.2** Implement feature flag:
  - Allow users to toggle between old/new models
  - Eventually default to new model
- [ ] **14.3** Version bump and changelog update

---

## Dependencies Between Phases
```
Phase 1 (Types) → Phase 2 (eCP) → Phase 3 (Cost) → Phase 4 (Chronic State)
                                                          ↓
Phase 5 (Questionnaire) ←────────────────────────────────┘
Phase 6 (RPE Loop) ← Phase 2, Phase 4
Phase 7 (useMetrics) ← All engine phases (2-6)
Phase 8 (Chart) ← Phase 7
Phase 9 (Dashboard) ← Phase 7
Phase 10 (Auto-Adaptive) ← Phase 4, Phase 7
Phase 11 (Session) ← Phase 3, Phase 6
Phase 12 (Docs) ← All phases
Phase 13 (Testing) ← All phases
Phase 14 (Migration) ← Phase 13
```
